import { GoogleGenAI } from "@google/genai";

/**
 * VINCI STUDIO - CORE SCRIPT
 * Patch CrÃ­tico: GestÃ£o de API Key (GEMINI_API_KEY) & Download de Imagem
 */

// --- GESTÃƒO DE API KEY (LOCALSTORAGE) ---

const getApiKey = () => (localStorage.getItem('GEMINI_API_KEY') || '').trim();

const updateApiKeyUI = () => {
    const key = getApiKey();
    const statusEl = document.getElementById('apiKeyStatus');
    const inputEl = document.getElementById('apiKeyInput');
    
    if (key) {
        if (statusEl) {
            statusEl.innerHTML = 'CHAVE ATIVA âœ…';
            statusEl.className = 'text-[10px] font-bold text-emerald-400 uppercase tracking-widest text-center pt-1';
        }
        if (inputEl) inputEl.value = key;
    } else {
        if (statusEl) {
            statusEl.innerHTML = 'CHAVE NÃƒO CONFIGURADA âŒ';
            statusEl.className = 'text-[10px] font-bold text-red-400 uppercase tracking-widest text-center pt-1';
        }
        if (inputEl) inputEl.value = '';
    }
};

// --- NAVEGAÃ‡ÃƒO ---

function setupNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const viewId = item.dataset.view;
            if (!viewId) return;

            navItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');

            document.querySelectorAll('.view-panel').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(`view-${viewId}`);
            if (target) target.classList.remove('hidden');
            
            const title = document.getElementById('view-title');
            if (title) title.innerText = item.innerText.trim();
        });
    });

    document.getElementById('sidebar-gen-img-btn')?.addEventListener('click', () => {
        document.querySelector('[data-view="images"]')?.click();
    });
}

// --- CHAMADAS DE IA ---

async function handleImageGeneration() {
    const key = getApiKey();
    if (!key) {
        alert("âš ï¸ ATENÃ‡ÃƒO: Salve sua Gemini API Key primeiro na barra lateral antes de gerar imagens.");
        document.getElementById('apiKeyInput')?.focus();
        return;
    }

    const prompt = document.getElementById('image-prompt')?.value.trim();
    if (!prompt) {
        alert("ðŸŽ¨ Escreva uma descriÃ§Ã£o para a sua imagem.");
        return;
    }

    const btn = document.getElementById('btn-generate-image');
    const loader = document.getElementById('loading-spinner');
    
    if (btn) btn.disabled = true;
    loader?.classList.remove('hidden');

    try {
        const style = document.getElementById('image-style')?.value || 'cinematic';
        const ratio = document.getElementById('image-ratio')?.value || '16:9';

        const ai = new GoogleGenAI({ apiKey: key });
        const fullPrompt = `Cinematic style: ${style}, high quality, hyper-realistic, 8k render, professional lighting, ${prompt}`;

        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash-image',
            contents: { parts: [{ text: fullPrompt }] },
            config: {
                imageConfig: { aspectRatio: ratio }
            }
        });

        const part = response.candidates[0].content.parts.find(p => p.inlineData);
        if (!part) throw new Error("A IA nÃ£o retornou dados de imagem.");

        const imageUrl = `data:image/png;base64,${part.inlineData.data}`;
        
        const wrapper = document.getElementById('image-preview-wrapper');
        const resultImg = document.getElementById('image-result');
        
        if (resultImg) resultImg.src = imageUrl;
        wrapper?.classList.remove('hidden');
        wrapper?.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error("AI Error:", error);
        alert("âŒ Erro na GeraÃ§Ã£o: " + (error.message || "Erro desconhecido"));
    } finally {
        if (btn) btn.disabled = false;
        loader?.classList.add('hidden');
    }
}

// --- DOWNLOAD DE IMAGEM ---

async function downloadGeneratedImage() {
    const img = document.getElementById('image-result');
    if (!img || !img.src || img.src === "") {
        alert("Nenhuma imagem para baixar.");
        return;
    }
    
    try {
        const response = await fetch(img.src);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        
        const d = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        const dateStr = d.getFullYear() + pad(d.getMonth() + 1) + pad(d.getDate());
        const timeStr = pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
        const filename = `avanco-ai-image-${dateStr}-${timeStr}.png`;
        
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        
        document.body.removeChild(link);
        URL.revokeObjectURL(blobUrl);
    } catch (e) {
        console.error("Download fail:", e);
        alert("Falha ao preparar o arquivo para download.");
    }
}

// --- INICIALIZAÃ‡ÃƒO ---

document.addEventListener('DOMContentLoaded', () => {
    // Carregar UI inicial
    updateApiKeyUI();

    // Eventos de API Key conforme solicitado no patch urgente
    document.getElementById("saveApiKeyBtn")?.addEventListener("click", () => {
        const v = document.getElementById("apiKeyInput").value.trim();
        if (!v) {
            alert("âš ï¸ Digite uma chave antes de salvar.");
            return;
        }
        localStorage.setItem("GEMINI_API_KEY", v);
        updateApiKeyUI();
        alert("âœ… Chave salva com sucesso!");
    });

    document.getElementById("clearApiKeyBtn")?.addEventListener("click", () => {
        localStorage.removeItem("GEMINI_API_KEY");
        updateApiKeyUI();
        alert("ðŸ—‘ï¸ Chave removida.");
    });

    // NavegaÃ§Ã£o
    setupNavigation();

    // Eventos de CriaÃ§Ã£o
    document.getElementById('btn-generate-image')?.addEventListener('click', handleImageGeneration);
    document.getElementById('btn-download-image')?.addEventListener('click', downloadGeneratedImage);
    
    document.getElementById('btn-save-gallery')?.addEventListener('click', () => {
        alert("Imagem adicionada Ã  sua galeria local!");
    });
});
